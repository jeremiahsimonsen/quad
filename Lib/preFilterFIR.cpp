/**
 * @file
 *
 * @brief Class for low-pass filtering raw accelerometer and gyro data
 *
 * @author Jasmine Despres
 * @author Jeremiah Simonsen
 *
 * @date Dec 6, 2015
 *
 */

/** @addtogroup Control
 *  @{
 */

/** @addtogroup PREFILTER
 *  @{
 */

#include "preFilterFIR.h"

/**
 * @brief Construct a preFilterFIR object
 *
 * Constructs an arbitary FIR filter object and initializes the ARM structs
 * and filter coefficients.
 */
preFilterFIR::preFilterFIR() {
	// FIR filter coefficients

#if 1
	// Fs = 800 Hz, Fpass = 0.5 Hz, Fstop = 4 Hz, Apass = 0.1 dB, Astop = -80 dB
	static float32_t coef[761] = {
		-0.000123, -0.000014, -0.000015, -0.000016, -0.000017, -0.000018, -0.000019, -0.000020, -0.000021, -0.000022,
		-0.000023, -0.000024, -0.000025, -0.000026, -0.000028, -0.000029, -0.000030, -0.000031, -0.000033, -0.000034,
		-0.000035, -0.000037, -0.000038, -0.000040, -0.000041, -0.000043, -0.000044, -0.000046, -0.000047, -0.000049,
		-0.000051, -0.000052, -0.000054, -0.000056, -0.000058, -0.000060, -0.000062, -0.000063, -0.000065, -0.000067,
		-0.000069, -0.000071, -0.000073, -0.000075, -0.000078, -0.000080, -0.000082, -0.000084, -0.000086, -0.000088,
		-0.000091, -0.000093, -0.000095, -0.000098, -0.000100, -0.000102, -0.000105, -0.000107, -0.000109, -0.000112,
		-0.000114, -0.000117, -0.000119, -0.000122, -0.000124, -0.000126, -0.000129, -0.000131, -0.000134, -0.000136,
		-0.000139, -0.000141, -0.000144, -0.000146, -0.000149, -0.000151, -0.000154, -0.000156, -0.000159, -0.000161,
		-0.000164, -0.000166, -0.000169, -0.000171, -0.000173, -0.000176, -0.000178, -0.000180, -0.000182, -0.000185,
		-0.000187, -0.000189, -0.000191, -0.000193, -0.000195, -0.000197, -0.000199, -0.000201, -0.000203, -0.000204,
		-0.000206, -0.000208, -0.000209, -0.000211, -0.000212, -0.000213, -0.000215, -0.000216, -0.000217, -0.000218,
		-0.000219, -0.000220, -0.000221, -0.000221, -0.000222, -0.000222, -0.000223, -0.000223, -0.000223, -0.000223,
		-0.000223, -0.000223, -0.000223, -0.000222, -0.000222, -0.000221, -0.000220, -0.000219, -0.000218, -0.000217,
		-0.000215, -0.000214, -0.000212, -0.000210, -0.000208, -0.000206, -0.000203, -0.000201, -0.000198, -0.000195,
		-0.000192, -0.000189, -0.000185, -0.000182, -0.000178, -0.000174, -0.000170, -0.000165, -0.000161, -0.000156,
		-0.000151, -0.000146, -0.000140, -0.000134, -0.000128, -0.000122, -0.000116, -0.000109, -0.000102, -0.000095,
		-0.000088, -0.000081, -0.000073, -0.000065, -0.000056, -0.000048, -0.000039, -0.000030, -0.000021, -0.000011,
		-0.000001, 0.000009, 0.000019, 0.000030, 0.000041, 0.000052, 0.000063, 0.000075, 0.000087, 0.000099,
		0.000112, 0.000125, 0.000138, 0.000151, 0.000165, 0.000179, 0.000194, 0.000208, 0.000223, 0.000238,
		0.000254, 0.000269, 0.000286, 0.000302, 0.000319, 0.000336, 0.000353, 0.000370, 0.000388, 0.000407,
		0.000425, 0.000444, 0.000463, 0.000482, 0.000502, 0.000522, 0.000542, 0.000563, 0.000584, 0.000605,
		0.000626, 0.000648, 0.000670, 0.000692, 0.000715, 0.000738, 0.000761, 0.000785, 0.000808, 0.000832,
		0.000857, 0.000881, 0.000906, 0.000931, 0.000957, 0.000982, 0.001008, 0.001035, 0.001061, 0.001088,
		0.001115, 0.001142, 0.001170, 0.001197, 0.001225, 0.001254, 0.001282, 0.001311, 0.001340, 0.001369,
		0.001398, 0.001428, 0.001458, 0.001488, 0.001518, 0.001548, 0.001579, 0.001610, 0.001641, 0.001672,
		0.001703, 0.001735, 0.001766, 0.001798, 0.001830, 0.001862, 0.001895, 0.001927, 0.001960, 0.001992,
		0.002025, 0.002058, 0.002091, 0.002124, 0.002157, 0.002191, 0.002224, 0.002257, 0.002291, 0.002325,
		0.002358, 0.002392, 0.002426, 0.002459, 0.002493, 0.002527, 0.002561, 0.002595, 0.002629, 0.002663,
		0.002697, 0.002730, 0.002764, 0.002798, 0.002832, 0.002866, 0.002899, 0.002933, 0.002966, 0.003000,
		0.003033, 0.003066, 0.003100, 0.003133, 0.003166, 0.003199, 0.003231, 0.003264, 0.003296, 0.003329,
		0.003361, 0.003393, 0.003425, 0.003456, 0.003488, 0.003519, 0.003550, 0.003581, 0.003612, 0.003642,
		0.003672, 0.003702, 0.003732, 0.003761, 0.003790, 0.003819, 0.003848, 0.003876, 0.003905, 0.003932,
		0.003960, 0.003987, 0.004014, 0.004040, 0.004067, 0.004093, 0.004118, 0.004143, 0.004168, 0.004193,
		0.004217, 0.004241, 0.004264, 0.004287, 0.004310, 0.004332, 0.004354, 0.004375, 0.004396, 0.004417,
		0.004437, 0.004456, 0.004476, 0.004495, 0.004513, 0.004531, 0.004549, 0.004566, 0.004582, 0.004598,
		0.004614, 0.004629, 0.004644, 0.004658, 0.004672, 0.004685, 0.004698, 0.004710, 0.004722, 0.004733,
		0.004744, 0.004754, 0.004764, 0.004773, 0.004782, 0.004790, 0.004798, 0.004805, 0.004812, 0.004818,
		0.004824, 0.004829, 0.004833, 0.004837, 0.004841, 0.004844, 0.004846, 0.004848, 0.004849, 0.004850,
		0.004850, 0.004850, 0.004849, 0.004848, 0.004846, 0.004844, 0.004841, 0.004837, 0.004833, 0.004829,
		0.004824, 0.004818, 0.004812, 0.004805, 0.004798, 0.004790, 0.004782, 0.004773, 0.004764, 0.004754,
		0.004744, 0.004733, 0.004722, 0.004710, 0.004698, 0.004685, 0.004672, 0.004658, 0.004644, 0.004629,
		0.004614, 0.004598, 0.004582, 0.004566, 0.004549, 0.004531, 0.004513, 0.004495, 0.004476, 0.004456,
		0.004437, 0.004417, 0.004396, 0.004375, 0.004354, 0.004332, 0.004310, 0.004287, 0.004264, 0.004241,
		0.004217, 0.004193, 0.004168, 0.004143, 0.004118, 0.004093, 0.004067, 0.004040, 0.004014, 0.003987,
		0.003960, 0.003932, 0.003905, 0.003876, 0.003848, 0.003819, 0.003790, 0.003761, 0.003732, 0.003702,
		0.003672, 0.003642, 0.003612, 0.003581, 0.003550, 0.003519, 0.003488, 0.003456, 0.003425, 0.003393,
		0.003361, 0.003329, 0.003296, 0.003264, 0.003231, 0.003199, 0.003166, 0.003133, 0.003100, 0.003066,
		0.003033, 0.003000, 0.002966, 0.002933, 0.002899, 0.002866, 0.002832, 0.002798, 0.002764, 0.002730,
		0.002697, 0.002663, 0.002629, 0.002595, 0.002561, 0.002527, 0.002493, 0.002459, 0.002426, 0.002392,
		0.002358, 0.002325, 0.002291, 0.002257, 0.002224, 0.002191, 0.002157, 0.002124, 0.002091, 0.002058,
		0.002025, 0.001992, 0.001960, 0.001927, 0.001895, 0.001862, 0.001830, 0.001798, 0.001766, 0.001735,
		0.001703, 0.001672, 0.001641, 0.001610, 0.001579, 0.001548, 0.001518, 0.001488, 0.001458, 0.001428,
		0.001398, 0.001369, 0.001340, 0.001311, 0.001282, 0.001254, 0.001225, 0.001197, 0.001170, 0.001142,
		0.001115, 0.001088, 0.001061, 0.001035, 0.001008, 0.000982, 0.000957, 0.000931, 0.000906, 0.000881,
		0.000857, 0.000832, 0.000808, 0.000785, 0.000761, 0.000738, 0.000715, 0.000692, 0.000670, 0.000648,
		0.000626, 0.000605, 0.000584, 0.000563, 0.000542, 0.000522, 0.000502, 0.000482, 0.000463, 0.000444,
		0.000425, 0.000407, 0.000388, 0.000370, 0.000353, 0.000336, 0.000319, 0.000302, 0.000286, 0.000269,
		0.000254, 0.000238, 0.000223, 0.000208, 0.000194, 0.000179, 0.000165, 0.000151, 0.000138, 0.000125,
		0.000112, 0.000099, 0.000087, 0.000075, 0.000063, 0.000052, 0.000041, 0.000030, 0.000019, 0.000009,
		-0.000001, -0.000011, -0.000021, -0.000030, -0.000039, -0.000048, -0.000056, -0.000065, -0.000073, -0.000081,
		-0.000088, -0.000095, -0.000102, -0.000109, -0.000116, -0.000122, -0.000128, -0.000134, -0.000140, -0.000146,
		-0.000151, -0.000156, -0.000161, -0.000165, -0.000170, -0.000174, -0.000178, -0.000182, -0.000185, -0.000189,
		-0.000192, -0.000195, -0.000198, -0.000201, -0.000203, -0.000206, -0.000208, -0.000210, -0.000212, -0.000214,
		-0.000215, -0.000217, -0.000218, -0.000219, -0.000220, -0.000221, -0.000222, -0.000222, -0.000223, -0.000223,
		-0.000223, -0.000223, -0.000223, -0.000223, -0.000223, -0.000222, -0.000222, -0.000221, -0.000221, -0.000220,
		-0.000219, -0.000218, -0.000217, -0.000216, -0.000215, -0.000213, -0.000212, -0.000211, -0.000209, -0.000208,
		-0.000206, -0.000204, -0.000203, -0.000201, -0.000199, -0.000197, -0.000195, -0.000193, -0.000191, -0.000189,
		-0.000187, -0.000185, -0.000182, -0.000180, -0.000178, -0.000176, -0.000173, -0.000171, -0.000169, -0.000166,
		-0.000164, -0.000161, -0.000159, -0.000156, -0.000154, -0.000151, -0.000149, -0.000146, -0.000144, -0.000141,
		-0.000139, -0.000136, -0.000134, -0.000131, -0.000129, -0.000126, -0.000124, -0.000122, -0.000119, -0.000117,
		-0.000114, -0.000112, -0.000109, -0.000107, -0.000105, -0.000102, -0.000100, -0.000098, -0.000095, -0.000093,
		-0.000091, -0.000088, -0.000086, -0.000084, -0.000082, -0.000080, -0.000078, -0.000075, -0.000073, -0.000071,
		-0.000069, -0.000067, -0.000065, -0.000063, -0.000062, -0.000060, -0.000058, -0.000056, -0.000054, -0.000052,
		-0.000051, -0.000049, -0.000047, -0.000046, -0.000044, -0.000043, -0.000041, -0.000040, -0.000038, -0.000037,
		-0.000035, -0.000034, -0.000033, -0.000031, -0.000030, -0.000029, -0.000028, -0.000026, -0.000025, -0.000024,
		-0.000023, -0.000022, -0.000021, -0.000020, -0.000019, -0.000018, -0.000017, -0.000016, -0.000015, -0.000014,
		-0.000123
	};
	int num_taps = 761;
#endif

	// state buffer used by arm routine of size NUMTAPS + blocksize - 1
	state = (float32_t *)malloc(sizeof(float32_t)*(num_taps));

	// arm FIR structure initialization
 	arm_fir_init_f32(&f, num_taps, &coef[0], state, 1);
}

/**
 * @brief   Calculate the filter output
 * @param x The current sample input
 * @return  The corresponding filter output
 *
 * Calculates the filtered value using the FIR filter coefficients from the
 * constructor.
 */
float32_t preFilterFIR::filterSample(float32_t *x) {
	float32_t y = 0.0f;

	arm_fir_f32(&f, x, &y, 1);

	return y;
}

/** @} Close PREFILTER group */
/** @} Close Control Group */


